import 'dart:async';
import 'package:pedometer/pedometer.dart';
import 'package:permission_handler/permission_handler.dart';

/// AdÄ±m Sayar Servisi (Step Counter Service)
/// Pedometer sensÃ¶rÃ¼nden gerÃ§ek zamanlÄ± adÄ±m verisi alÄ±r
/// Singleton pattern ile tek instance
class StepService {
  // Singleton instance
  static final StepService _instance = StepService._internal();
  factory StepService() => _instance;
  StepService._internal();

  // Stream controller - UI'a adÄ±m verisi akÄ±ÅŸÄ±
  final StreamController<int> _stepStreamController =
      StreamController<int>.broadcast();

  // Pedometer subscription
  StreamSubscription<StepCount>? _stepSubscription;

  // Son adÄ±m sayÄ±sÄ±
  int _currentSteps = 0;
  int get currentSteps => _currentSteps;

  /// AdÄ±m stream'i (UI'Ä±n dinleyeceÄŸi)
  Stream<int> get stepStream => _stepStreamController.stream;

  /// AdÄ±m saymayÄ± baÅŸlat
  Future<void> startCounting() async {
    // EÄŸer zaten dinliyorsa, tekrar baÅŸlatma
    if (_stepSubscription != null) {
      return;
    }

    try {
      // Android iÃ§in ACTIVITY_RECOGNITION izni iste
      PermissionStatus status = await Permission.activityRecognition.request();

      if (status.isGranted) {
        // Ä°zin verildi, sensÃ¶rÃ¼ dinle
        _stepSubscription = Pedometer.stepCountStream.listen(
          _onStepCount,
          onError: _onStepCountError,
        );
      } else {
        // Ä°zin verilmedi
        _stepStreamController.addError('Ä°zin verilmedi. Ayarlardan ACTIVITY_RECOGNITION iznini aÃ§Ä±n.');
      }
    } catch (e) {
      _stepStreamController.addError('AdÄ±m sayar baÅŸlatÄ±lamadÄ±: $e');
    }
  }

  /// AdÄ±m verisi geldiÄŸinde Ã§aÄŸrÄ±lÄ±r
  void _onStepCount(StepCount event) {
    _currentSteps = event.steps;
    _stepStreamController.add(_currentSteps);
    print('ğŸ“Š AdÄ±m SayÄ±sÄ±: $_currentSteps');
  }

  /// Hata durumunda Ã§aÄŸrÄ±lÄ±r
  void _onStepCountError(error) {
    print('âŒ AdÄ±m sayar hatasÄ±: $error');
    
    // KullanÄ±cÄ±ya anlamlÄ± hata mesajÄ±
    if (error.toString().contains('not available')) {
      _stepStreamController.addError('AdÄ±m sensÃ¶rÃ¼ bulunamadÄ±');
    } else {
      _stepStreamController.addError('SensÃ¶r hatasÄ±: $error');
    }
  }

  /// AdÄ±m saymayÄ± durdur
  void stopCounting() {
    _stepSubscription?.cancel();
    _stepSubscription = null;
  }

  /// Servisi temizle
  void dispose() {
    stopCounting();
    _stepStreamController.close();
  }
}
